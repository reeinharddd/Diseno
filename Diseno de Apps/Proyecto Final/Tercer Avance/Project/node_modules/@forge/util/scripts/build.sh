#! /bin/bash

rm -rf ./tmp || true
rm -rf ./packages || true

function source-matches-destination () {
  if [ -d "$1" ] && [ -d "$2" ] && diff -r "$1" "$2"
  then
    true
  else
    false
  fi
}

function add-package () {
  PACKAGE=$1
  DESTINATION=$(echo "$1" | rev | cut -d '@' -f 2 | cut -d '/'  -f 1 | rev )
  MAX_COPY_RETRIES=3

  mkdir -p "./tmp/$DESTINATION"
  mkdir -p "./packages/$DESTINATION"

  cd "./tmp/$DESTINATION" &&
  npm pack $PACKAGE &&
  tar -xvf *.tgz &&

  retries=0
  cp -R "./package/." "../../packages/$DESTINATION"
  until source-matches-destination "./package/." "../../packages/$DESTINATION" || [ $retries -gt $MAX_COPY_RETRIES ]
  do
    echo "Copying $PACKAGE from $(pwd)/package to $(pwd)/../../packages/$DESTINATION failed"
    echo "Retrying copy (attempt $retries of $MAX_COPY_RETRIES)"
    cp -R "./package/." "../../packages/$DESTINATION"
    (( retries++ ))
  done
  cd ../../

  if [ $retries -gt $MAX_COPY_RETRIES ];
  then
    echo "Copying $PACKAGE failed!"
    return 1
  fi
}

add-package @atlassian/logger-interface@1.3.7
add-package @atlassian/cs-ari@1.10.0
add-package @atlassiansox/analytics-node-client@1.0.111

find ./packages

node ./scripts/replace-packages.js

rm -rf ./tmp
