# Analytics Node Client

Analytics Client NodeJS services. Uses the GASv3 platform.

* [Builds](https://engservices-bamboo.internal.atlassian.com/browse/DS-ANCBUILD)
* [Event Guidelines](http://go.atlassian.com/analytics)
* Questions / Other support: visit us in Slack: #product-analytics-dev "Product Analytics Dev"

## Usage

#### Creating a client

```javascript
const { analyticsClient } = require('@atlassiansox/analytics-node-client');

const client = analyticsClient({
    env: 'prod', // prod, stg or dev
    product: 'jira', // required
    subproduct: 'software' // Optional
    sendEventHook: (event) => {} // Optional callback
});
```

#### User information 

If a `userId` is specified, then a valid `userIdType` is also required. If no `userId` is specified, then `anonymousId` must be used.

We support the following `userIdType`s: 

* `ATLASSIAN_ACCOUNT`
* `TRELLO` 


#### Tenant information 

If a `tenantId` is specified, then a valid `tenantIdType` is also required. 

We support the following `tenantIdType`s: 

* `CLOUD_ID` - Atlassian Cloud 
* `NONE` - Products without a tenant concept

#### Containers

The `containers` field is meant to be the new representation of the container hierarchy where the event takes place. Think something like issue -> board -> project.
Check more info about the `containers` field in this [doco](https://hello.atlassian.net/wiki/spaces/ANALYTICS/pages/463696450/DACI+Flexible+entity+hierarchy+in+analytics+events).
There is no strict definition or schema for the fields allowed in the containers; except all containers need to have an `id` field, and can optionally have a `type` field. Only string values are allowed for `id` and `type`. Any other fields added will be silently stripped out before sending the event.
The `containers` field will be validated, and will throw and `Error` if the validation does not pass, preventing the event from being sent.
You need to put the values that will make the analytical events valuable to your use case; most probayly matching the expectations set by some analyst's queries on top of the Socrates, Redash or Amplitude tables.
An example of a `containers` structure:
```
"containers": {
    "project": {
        "id": "projectId",
        "type": "software"
    },
    "board": {
        "id": "boardId",
        "type": "kanban",
    },
    "issue": {
        "id": "issueId",
        "type": "bug"
    }
}
```


#### Reporting OS info/version
OS version can be optionally reported with `os` attribute of an event:
```javascript
{
    ...
    os: {
        name: os.platform(),
        version: os.version()
    }
}
```

#### Reporting event creation time
Creation time of the analytics event can be optionally reported with the `timestamp` attribute of an event:
```javascript
this.analyticsClient.track({
    ...
    timestamp: new Date()
})
```
For compatibility with the underlying `node-analytics` library the timestamp must be supplied as a Date object.
This creation timestamp will be reflected as `originalTimestamp` after processing.



## Sending a TrackEvent

```javascript
client.sendTrackEvent({
    userId: 'some-user-id',
    anonymousId: 'some-anonymous-id',
    userIdType: 'atlassianAccount',
    tenantIdType: 'cloudId',
    tenantId: 'some-tenant-id',
    trackEvent: {
        source: 'api', // required
        action: 'testAction', // required
        actionSubject: 'testActionSubject', // required
        actionSubjectId: 'my-action-subject-id'
        attributes: {
            attribute: 'my-attribute-info',
        },
        containers: { // optional
            project: {
                id: 'b1875f21-434f-4d3f-a57c-2962b154d947', // required
                type: 'kanban' // optional
            },
            board: {
                id: 'b5533697-c14c-442b-8773-03da44741831', // required
                type: 'public' // optional
            }
        }
    }
});
```

#### TrackEvent with OS details:

```javascript
client.sendTrackEvent({
    userId: 'some-user-id',
    anonymousId: 'some-anonymous-id',
    userIdType: 'atlassianAccount',
    tenantIdType: 'cloudId',
    tenantId: 'some-tenant-id',
    trackEvent: {
        source: 'api', // required
        action: 'testAction', // required
        actionSubject: 'testActionSubject', // required
        actionSubjectId: 'my-action-subject-id'
        attributes: {
            attribute: 'my-attribute-info',
        },
        containers: { // optional
            project: {
                id: 'b1875f21-434f-4d3f-a57c-2962b154d947', // required
                type: 'kanban' // optional
            },
            board: {
                id: 'b5533697-c14c-442b-8773-03da44741831', // required
                type: 'public' // optional
            }
        }
    },
    os: {
        name: os.platformt(),
        version: os.version()
    }
});
```

## Sending a UIEvent

```javascript
client.sendUIEvent({
    userId: 'some-user-id',
    anonymousId: 'some-anonymous-id',
    userIdType: 'atlassianAccount',
    tenantIdType: 'cloudId',
    tenantType: 'my-tenant-type',
    uiEvent: {
        source: 'api',
        action: 'testAction', // required
        actionSubject: 'testActionSubject', // required
        actionSubjectId: 'my-action-subject-id',
        attributes: {
            attribute: 'my-attribute-info',
        },
        containers: { // optional
            project: {
                id: 'b1875f21-434f-4d3f-a57c-2962b154d947', // required
                type: 'kanban' // optional
            },
            board: {
                id: 'b5533697-c14c-442b-8773-03da44741831', // required
                type: 'public' // optional
            }
        }
    }
});
```

## Sending a ScreenEvent

```javascript
client.sendScreenEvent({
    userId: 'some-user-id',
    anonymousId: 'some-anonymous-id',
    userIdType: 'atlassianAccount',
    tenantIdType: 'cloudId',
    tenantType: 'my-tenant-type',
    name: 'some-screen-name', // required
    screenEvent: {
        origin: 'some-origin', // required
        platform: 'some-platform', // required
        attributes: {
            attribute: 'my-attribute-info',
        },
        containers: { // optional
            project: {
                id: 'b1875f21-434f-4d3f-a57c-2962b154d947', // required
                type: 'kanban' // optional
            },
            board: {
                id: 'b5533697-c14c-442b-8773-03da44741831', // required
                type: 'public' // optional
            }
        }
    }
});
```

## Sending a OperationalEvent

```javascript
client.sendOperationalEvent({
    userId: 'some-user-id',
    anonymousId: 'some-anonymous-id',
    userIdType: 'atlassianAccount',
    tenantIdType: 'cloudId',
    tenantId: 'some-tenant-id',
    operationalEvent: {
        source: 'api', // required
        action: 'testAction', // required
        actionSubject: 'testActionSubject', // required
        actionSubjectId: 'my-action-subject-id'
        attributes: {
            attribute: 'my-attribute-info',
        },
        containers: { // optional
            project: {
                id: 'b1875f21-434f-4d3f-a57c-2962b154d947', // required
                type: 'kanban' // optional
            },
            board: {
                id: 'b5533697-c14c-442b-8773-03da44741831', // required
                type: 'public' // optional
            }
        }
    }
});
```

## Developing Locally

Setup: `npm install`

### Tests:

`npm test`
